from flask import Flask, jsonify
from flask_cors import CORS
from threading import Thread
import time
from get_devices import scan_network, get_local_ip_range

app = Flask(__name__)
CORS(app)

# Global variable to store the devices
devices_list = []

# Function to run the scan continuously in the background
def continuous_scan():
    while True:
        try:
            ip_range = get_local_ip_range()
            devices = scan_network(ip_range)
            global devices_list
            devices_list = devices  # Update the global devices list
        except Exception as e:
            print(f"Error during scan: {e}")
        time.sleep(60)  # Run the scan every 60 seconds

@app.route('/api/devices', methods=['GET'])
def get_devices():
    try:
        # Return the devices that were last scanned
        return jsonify({"status": "success", "devices": devices_list}), 200
    except Exception as e:
        return jsonify({"status": "error", "message": str(e)}), 500

if __name__ == '__main__':
    # Start the continuous scan in a background thread when the app starts
    scan_thread = Thread(target=continuous_scan)
    scan_thread.daemon = True
    scan_thread.start()
    
    app.run(debug=True, host='0.0.0.0', port=5000)
